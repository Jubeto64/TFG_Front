{% extends 'base.html' %} {% block title %} Laudos {% endblock %} {% block content %}
<script src="https://code.highcharts.com/maps/highmaps.js"></script>
<script src="https://code.highcharts.com/maps/modules/data.js"></script>
<script src="https://code.highcharts.com/maps/modules/data.js"></script>
<script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
<script src="https://code.highcharts.com/maps/modules/offline-exporting.js"></script>

<div class="offset-1 col-10 list-div">
    <h1 id='name'>Dashboard</h1>
    <input type="text" id="desc" name="desc" placeholder="Descrição da Natureza" size="60px">
    <button type="submit" class="btn btn-secondary" style="margin-top: 10px; margin-bottom: 30px;" onclick="toggleVis(this.name)"><i
        class="bi bi-search "></i></button>
    <div class="col-10">
        <div id="wrapper">
            <div id="mapa" style="height:800px"></div>
            <div id="info">
                <span class="f32"><span id="flag"></span></span>
                <div id="grafico_linha">
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    $.getJSON('/dadosMapa/' + '?desc=' + document.getElementById('desc').value, function(teste) {
        data = teste
            //console.log(data)

        Highcharts.getJSON('https://raw.githubusercontent.com/tbrugz/geodata-br/master/geojson/geojs-31-mun.json', function(geojson) {

            // Initiate the chart
            Highcharts.mapChart('mapa', {
                chart: {
                    map: geojson
                },

                credits: {
                    enabled: false,
                },

                title: {
                    text: 'Unidades Requisitante MG'
                },

                mapNavigation: {
                    enabled: true,
                    buttonOptions: {
                        verticalAlign: 'bottom'
                    }
                },

                colorAxis: {
                    tickPixelInterval: 100
                },

                series: [{
                    animation: {
                        duration: 100
                    },
                    data: data,
                    keys: ['cod_unidade_requisitante__geocodigo', 'value'],
                    joinBy: ['id', 'cod_unidade_requisitante__geocodigo'],
                    name: 'Qtd. de Laudos',
                    states: {
                        hover: {
                            color: '#3d3b8e'
                        }
                    },
                    dataLabels: {
                        enabled: false,
                        color: 'white',
                        format: '{point.name}'
                    }
                }],
                plotOptions: {
                    series: {
                        cursor: 'pointer',
                        point: {
                            events: {
                                click: function() {
                                    x = this.cod_unidade_requisitante__geocodigo
                                    console.log('camada 1:', x)
                                    var name = this.properties.name;
                                    $.getJSON('/dadosGraf/' + x + '/?desc=' + document.getElementById('desc').value, function(teste2) {
                                        data2 = teste2
                                        console.log('camada 2:', data2)
                                        data = [];
                                        value = [];

                                        function formatDate(date) {
                                            var d = new Date(date),
                                                month = '' + (d.getMonth() + 1),
                                                day = '' + d.getDate(),
                                                year = d.getFullYear();

                                            if (month.length < 2)
                                                month = '0' + month;
                                            if (day.length < 2)
                                                day = '0' + day;

                                            return [month, year].join('/');
                                        }
                                        for (i = 0; i < data2.length; i++) {
                                            // var d = new Date(data2[i].mes_registro);
                                            // data += toDate('mm/yyyyy') + ',';
                                            data[i] = formatDate(data2[i].mes_registro);
                                            value[i] = data2[i].laudo_nmr;
                                        }
                                        // var data_final = '[' + data.substring(0, data.length - 2) + ']';
                                        // var value_final = '[' + value.substring(0, value.length - 2) + ']';
                                        // console.log(data_final)
                                        // console.log(value_final)
                                        // console.log(this)
                                        console.log(data, value)

                                        Highcharts.chart('grafico_linha', {

                                            title: {
                                                text: name
                                            },

                                            yAxis: {
                                                title: {
                                                    text: 'Número de laudos'
                                                }
                                            },

                                            xAxis: {
                                                // type: "category",
                                                categories: data
                                            },

                                            legend: {
                                                layout: 'vertical',
                                                align: 'right',
                                                verticalAlign: 'middle'
                                            },

                                            // plotOptions: {
                                            //     line: {
                                            //         dataLabels: {
                                            //             enabled: true
                                            //         },
                                            //     }
                                            // },

                                            series: [{
                                                name: 'Número de Laudos',
                                                data: value
                                            }],

                                            responsive: {
                                                rules: [{
                                                    condition: {
                                                        maxWidth: 500
                                                    },
                                                    chartOptions: {
                                                        legend: {
                                                            layout: 'horizontal',
                                                            align: 'center',
                                                            verticalAlign: 'bottom'
                                                        }
                                                    }
                                                }]
                                            }

                                        });
                                        // chart.addSeries({
                                        //     data: value_final,
                                        // })
                                    })
                                }
                            }
                        }
                    }
                },
            });
        });
    });
</script>
{% endblock %}